#!/bin/sh
#
# Copyright (c) 2018 Mark Heily <mark@heily.com>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#

if [ "$1" = "--as-current-user" ] ; then
    shift
    export PREFIX=$HOME/.local
    export BINDIR=$HOME/.local/bin
    export SBINDIR=$HOME/.local/bin
    export PKGCONFIGDIR=$HOME/.config
    export LOCALSTATEDIR=$HOME/.config
    export RUNSTATEDIR=/run/user/$(id -u)
    export MANDIR=$HOME/.local/share/man
    exec ./configure $*
fi

prefix=${PREFIX:-/lib/jobd}
exec_prefix=${EXEC_PREFIX:-${prefix}}
bindir=${BINDIR:-/bin}
sbindir=${SBINDIR:-/sbin}
pkgconfigdir=${PKGCONFIGDIR:-/etc/jobd}
datarootdir=${DATAROOTDIR:-${prefix}}
libexecdir=${LIBEXECDIR:-${exec_prefix}/libexec}
localstatedir=${LOCALSTATEDIR:-${prefix}}
mandir=${MANDIR:-/usr/share/man}
rundir=${RUNDIR:-/run}
runstatedir=${RUNSTATEDIR:-/var/run/jobd}

cat >config.mk <<EOF
# DO NOT EDIT -- automatically generated by ./configure

PREFIX := $prefix
BINDIR := $bindir
SBINDIR := $sbindir
PKGCONFIGDIR := $pkgconfigdir
DATAROOTDIR := $datarootdir
LIBEXECDIR := $libexecdir
LOCALSTATEDIR := $localstatedir
MANDIR := $mandir
RUNDIR := $rundir
RUNSTATEDIR := $runstatedir
EOF

cat config.mk | sed -E 's/ := (.*)/="\1"/' > config.inc

cat >config.h <<EOF
/* DO NOT EDIT -- automatically generated by ./configure */

#ifndef _CONFIG_H
#define _CONFIG_H

static const struct {
    const char *prefix;
    const char *bindir;
    const char *sbindir;
    const char *pkgconfigdir;
    const char *datarootdir;
    const char *libexecdir;
    const char *localstatedir;
    const char *rundir;
    const char *runstatedir;
} compile_time_option = {
    .prefix = "${prefix}",
    .bindir = "${bindir}",
    .sbindir = "${sbindir}",
    .pkgconfigdir = "${pkgconfigdir}",
    .datarootdir = "${datarootdir}",
    .libexecdir = "${libexecdir}",
    .localstatedir = "${localstatedir}",
    .rundir = "${rundir}",
    .runstatedir = "${runstatedir}"
};

#endif /* _CONFIG_H */
EOF
